{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "actionGroups_name": {
            "defaultValue": "myActionGroup",
            "type": "string"
        },
        "actionGroups_shortname": {
            "defaultValue": "myag",
            "type": "string"
        },
        "action_prefix": {
           "type": "string",
           "metadata": {
                "description": "This is a shared name across all of the different possible acitons. It will concatenate to form a sensible name based on the type of action."
            },
            "defaultValue": "action"
        },
        "common_alert_schema": {
           "type": "bool",
           "metadata": {
                "description": "Specifies whether or not to use the common alert schema. This will be consistent across all actions."
            },
            "defaultValue": false
        },
        "emailAddress": {
           "type": "string",
           "metadata": {
                "description": "Specify an email address to send alerts to."
            },
            "defaultValue": ""
        },
        "voiceNumber": {
           "type": "string",
           "metadata": {
                "description": "Specify an phone number to call with an alert."
            },
            "defaultValue": ""
        },
        "smsNumber": {
           "type": "string",
           "metadata": {
                "description": "Specify an phone number to text with an alert."
            },
            "defaultValue": ""
        },
        "webhookURI": {
            "type": "string",
            "metadata": {
                 "description": "Specify a webhook to invoke with an alert"
             },
             "defaultValue": ""
         },
         "automationAccountId": {
            "type": "string",
            "metadata": {
                 "description": ""
            },
            "defaultValue": ""
         },
        "automationRunbookName": {
            "type": "string",
            "metadata": {
                    "description": "Specify the runbook to invoke with an alert."
            },
            "defaultValue": ""
        },
        "automationWebhookResourceId": {
            "type": "string",
            "metadata": {
                    "description": ""
            },
            "defaultValue": ""
        },
        "isGlobalRunbook": {
            "type": "bool",
            "metadata": {
                    "description": "Specify True if this is a built-in runbook."
            },
            "defaultValue": false
        },
        "azureAutomationServiceURI": {
            "type": "string",
            "metadata": {
                    "description": "Specify the serviceUri for Azure Automation... NOTE: THIS CONTENTS A TOKEN AND SHOULD BE TREATED AS A SECRET VALUE"
            },
            "defaultValue": ""
        },
        "logicAppResourceId": {
            "type": "string",
            "metadata": {
                    "description": "//TODO Add real description"
            },
            "defaultValue": ""
        },
        "logicAppCallbackUrl": {
            "type": "string",
            "metadata": {
                    "description": "//TODO Add real description"
            },
            "defaultValue": ""
        },  
        "functions_externalid": {
            "type": "string",
            "metadata": {
                    "description": "//TODO Add real description"
            },
            "defaultValue": ""
        },
        "functions_name": {
            "type": "string",
            "metadata": {
                    "description": "//TODO Add real description"
            },
            "defaultValue": ""
        },
        "functions_trigger_url": {
            "type": "string",
            "metadata": {
                    "description": "//TODO Add real description"
            },
            "defaultValue": ""
        }    
    },
    "variables": {
        "sendEmail?": "[not(empty(parameters('emailAddress')))]",
        "emailReceiversProperties": 
            {
                "name": "[concat(parameters('action_prefix'), '-email')]",
                "emailAddress": "[parameters('emailAddress')]",
                "useCommonAlertSchema": "[parameters('common_alert_schema')]"
            },
        "call?": "[not(empty(parameters('voiceNumber')))]",
        "voiceReceiversProperties":
        {
            "name": "[concat(parameters('action_prefix'), '-call')]",
            "countryCode": "1",
            "phoneNumber": "[parameters('voiceNumber')]"
        },
        "text?": "[not(empty(parameters('smsNumber')))]",
        "smsReceiversProperties":
            {
                "name": "[concat(parameters('action_prefix'), '-sms')]",
                "countryCode": "1",
                "phoneNumber": "[parameters('smsNumber')]"
            },
        "webhook?": "[not(empty(parameters('webhookURI')))]",
        "webhookReceiversProperties":
            {
                "name": "[concat(parameters('action_prefix'), '-webhook')]",
                "serviceUri": "[parameters('webhookURI')]",
                "useCommonAlertSchema": "[parameters('common_alert_schema')]"
            },
        "azureautomation?": "[and(not(empty(parameters('azureAutomationServiceURI'))), not(empty(parameters('automationAccountId'))), not(empty(parameters('automationRunbookName'))), not(empty(parameters('automationWebhookResourceId'))))]",
        "automationRunbookReceiversProperties":
            {
                "automationAccountId": "[parameters('automationAccountId')]",
                "runbookName": "[parameters('automationRunbookName')]",
                "webhookResourceId": "[concat(parameters('automationAccountId'), '/webhooks/', parameters('automationWebhookResourceId'))]",
                "isGlobalRunbook": "[parameters('isGlobalRunbook')]",
                "name": "[concat(parameters('action_prefix'), '-aa')]",
                "serviceUri": "[parameters('azureAutomationServiceURI')]",
                "useCommonAlertSchema": "[parameters('common_alert_schema')]"
            },
        "logicapps?": "[and(not(empty(parameters('logicAppResourceId'))), not(empty(parameters('logicAppCallbackUrl'))))]",
        "logicAppReceiversProperties":                    
            {
                "name": "[concat(parameters('action_prefix'), '-logicapp')]",
                "resourceId": "[parameters('logicAppResourceId')]",
                "callbackUrl": "[parameters('logicAppCallbackUrl')]",
                "useCommonAlertSchema": "[parameters('common_alert_schema')]"
            },
        "functions?": "[and(not(empty(parameters('functions_externalid'))), not(empty(parameters('functions_name'))), not(empty(parameters('functions_trigger_url'))))]",
        "azureFunctionReceiversProperties":
            {
                "name": "[concat(parameters('action_prefix'), '-function')]",
                "functionAppResourceId": "[parameters('functions_externalid')]",
                "functionName": "[parameters('functions_name')]",
                "httpTriggerUrl": "[parameters('functions_trigger_url')]",
                "useCommonAlertSchema": "[parameters('common_alert_schema')]"
            }
    },
    "resources": [
        {
            "type": "microsoft.insights/actionGroups",
            "apiVersion": "2019-03-01",
            "name": "[parameters('actionGroups_name')]",
            "location": "Global",
            "properties": {
                "groupShortName": "[parameters('actionGroups_shortname')]",
                "enabled": true,
                "emailReceivers": "[if(variables('sendEmail?'), variables('emailReceiversProperties'), json('null'))]",
                "smsReceivers": "[if(variables('text?'), variables('smsReceiversProperties'), json('null'))]",
                "voiceReceivers": "[if(variables('call?'), variables('voiceReceiversProperties'), json('null'))]",
                "webhookReceivers": "[if(variables('webhook?'), variables('webhookReceiversProperties'), json('null'))]",
                "itsmReceivers": [], 
                "azureAppPushReceivers": [], 
                "automationRunbookReceivers": "[if(variables('azureautomation?'), variables('automationRunbookReceiversProperties'), json('null'))]",
                "logicAppReceivers": "[if(variables('logicapps?'), variables('logicAppReceiversProperties'), json('null'))]",
                "azureFunctionReceivers": "[if(variables('functions?'), variables('azureFunctionReceiversProperties'), json('null'))]"       
            }
        }
    ],
    "outputs": {
        "action_group_id": {
            "type": "string",
            "value": "test"
        }
    }
}



